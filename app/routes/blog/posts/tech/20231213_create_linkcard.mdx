---
title: 'Cloudflare Workersã®HTMLRewriterã‚’ä½¿ã£ã¦ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹'
description: ''
pubDate: '2023/12/14 0:23'
tag: 'tech'
icon: 'smilieys/39'
---

æœ€è¿‘Cloudflareã‚’è§¦ã£ã¦ã¿ã‚‹ã®ãŒæ¥½ã—ãã€è‰²ã€…è©¦ã—ã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã“ã®ã‚µã‚¤ãƒˆã¯Cloudflare Pagesã§ãƒ›ã‚¹ãƒˆã—ã€è¨˜äº‹ã®ä¸‹ã«ã‚ã‚‹çµµæ–‡å­—ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚Workers KVã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€æœ€è¿‘Honoã‚‚ç†±ãã€Workersã¨ä¸€ç·’ã«ä½¿ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã€Cloudflare Workersã®HTMLRewriter + Honoã§è¨˜äº‹ã«ã‚ã‚‹ãƒªãƒ³ã‚¯ã‚’ã‚«ãƒ¼ãƒ‰ã«ã—ã¦è¡¨ç¤ºã§ãã‚‹ã‚‚ã®ã‚’ä½œã‚Šã¾ã—ãŸã€‚

## ç›®æ¬¡

## å‚è€ƒã«ã—ãŸã‚‚ã®

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ä¸€é€šã‚Šå®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

https://zenn.dev/uyas/articles/0b7dcbb46d8031

HTMLRewriterè‡ªä½“ã¯Workersä¸Šã§å‹•ãHTMLãƒ‘ãƒ¼ã‚µãƒ¼ã§ã€ä¾‹ãˆã°ã‚µã‚¤ãƒˆã®å¤ã„ãƒªãƒ³ã‚¯ã‚’æ–°ã—ã„ã‚‚ã®ã¸ã¨å‹•çš„ã«æ›¸ãæ›ãˆãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚‚ã®ã§ã™ã€‚

https://developers.cloudflare.com/workers/runtime-apis/html-rewriter/

ä»Šå›ã€ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹ã®ã«å¿…è¦ãªãƒªãƒ³ã‚¯å…ˆã®æƒ…å ±ã¯ä»¥ä¸‹ã§ã™ã€‚

- title
- favicon URL
- meta description

ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€æœ¬æ¥ã®ç”¨é€”ã¨ã¯é•ã„ã¾ã™ãŒãƒªãƒ³ã‚¯å…ˆã®HTMLã‚’è§£æã—ã¦è©²å½“ã®ã‚¿ã‚°ã«å¯¾ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

## Honoã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Workersã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€Honoã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://hono.dev/getting-started/cloudflare-workers

ä¸Šè¨˜ã«æ›¸ã„ã¦ã‚ã‚‹æ‰‹é †ã®é€šã‚Šä»¥ä¸‹ã‚’è¡Œã„ã¾ã™ã€‚

1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã§`npm create hono@latest linkcard`ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
2. `cd linkcard`ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç§»å‹•
3. `npm i`ã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

## å®Ÿè£…ã™ã‚‹

æº–å‚™ã¯æ•´ã£ãŸã®ã§ã€`index.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

```ts :src/index.ts
import { Hono } from 'hono';

const app = new Hono();

class TitleHandler {
  title: string;

  constructor() {
    this.title = '';
  }

  text(text: Text) {
    if (!this.title && text.text) {
      this.title = text.text;
    }
  }
}

class OgpHandler {
  title: string;
  description: string;

  constructor() {
    this.title = '';
    this.description = '';
  }

  element(element: Element) {
    if (element.getAttribute('name') === 'description') {
      this.description = element.getAttribute('content') ?? '';
      return;
    }

    const property = element.getAttribute('property');

    if (property === 'og:title') {
      this.title = element.getAttribute('content') ?? '';
    } else if (property === 'og:description') {
      this.description = element.getAttribute('content') ?? '';
    }
  }
}

class FaviconHandler {
  faviconUrl: string;

  constructor() {
    this.faviconUrl = '';
  }

  element(element: Element) {
    if (
      element.getAttribute('rel') === 'icon' ||
      element.getAttribute('rel') === 'shortcut icon'
    ) {
      this.faviconUrl = element.getAttribute('href') ?? '';
    }
  }
}

const hasValidPrefix = (url: string) =>
  ['http', 'https', 'data'].some((prefix) => url.startsWith(prefix));

app.get('/api/linkCard', async (c) => {
  const url = c.req.query('url');
  if (url === undefined) {
    return c.body('Bad Request', 400);
  }

  const parsedUrl = new URL(url);
  const decodedHref = decodeURIComponent(url);
  const siteRes = await fetch(decodedHref);
  if (!siteRes.ok) {
    return c.body('Not Found', 404);
  }

  const titleHandler = new TitleHandler();
  const ogpHandler = new OgpHandler();
  const faviconHandler = new FaviconHandler();
  const res = new HTMLRewriter()
    .on('title', titleHandler)
    .on('meta', ogpHandler)
    .on('link', faviconHandler)
    .transform(siteRes);
  await res.text();

  const days = 24 * 60 * 60;
  c.header('Cache-Control', `public, s-maxage=${1 * days}`);

  return c.json({
    title: titleHandler.title ?? ogpHandler.title,
    description: ogpHandler.description,
    siteName: parsedUrl.hostname,
    faviconUrl: hasValidPrefix(faviconHandler.faviconUrl)
      ? faviconHandler.faviconUrl
      : `${parsedUrl.origin}${faviconHandler.faviconUrl}`,
  });
});

export default app;
```

ä¸€ã¤ãšã¤è¦‹ã¦ã„ãã¾ã™ã€‚

ã¾ãšã€`/api/linkCard`ã¨ã„ã†ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã€`https://xxxxxxx.workers.dev/api/linkCard`ã§ã“ã®Workerã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚  
ç‰¹å®šã®ãƒªãƒ³ã‚¯å…ˆã®æƒ…å ±ã‚’å–å¾—ã—ãŸã„ã®ã§ã€`https://xxxxxxx.workers.dev/api/linkCard?url=https://yyyy.com/zzz`ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

urlã®å€¤ã‚’c.req.queryã§å–å¾—ã—ã€ãã®URLã‚’ã‚‚ã¨ã«URLå‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts
app.get('/api/linkCard', async (c) => {
  const url = c.req.query('url');
  if (url === undefined) {
    return c.body('Bad Request', 400);
  }

  const parsedUrl = new URL(url);
  const decodedHref = decodeURIComponent(url);
  const siteRes = await fetch(decodedHref);
  if (!siteRes.ok) {
    return c.body('Not Found', 404);
  }
...
```

ã“ã“ã‹ã‚‰HTMLRewriterã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚  
åŸºæœ¬çš„ã«1ã¤ã®ã‚¿ã‚°è¦ç´ ã«å¯¾ã—ã¦1ã¤ã®Handlerã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä»Šå›ã¯ title,favicon URL,meta description ã®3ã¤åˆ†ä½œã‚Šã¾ã™ã€‚

```ts
class TitleHandler {
  title: string;

  constructor() {
    this.title = '';
  }

  text(text: Text) {
    if (!this.title && text.text) {
      this.title = text.text;
    }
  }
}

class OgpHandler {
  title: string;
  description: string;

  constructor() {
    this.title = '';
    this.description = '';
  }

  element(element: Element) {
    if (element.getAttribute('name') === 'description') {
      this.description = element.getAttribute('content') ?? '';
      return;
    }

    const property = element.getAttribute('property');

    if (property === 'og:title') {
      this.title = element.getAttribute('content') ?? '';
    } else if (property === 'og:description') {
      this.description = element.getAttribute('content') ?? '';
    }
  }
}

class FaviconHandler {
  faviconUrl: string;

  constructor() {
    this.faviconUrl = '';
  }

  element(element: Element) {
    if (
      element.getAttribute('rel') === 'icon' ||
      element.getAttribute('rel') === 'shortcut icon'
    ) {
      this.faviconUrl = element.getAttribute('href') ?? '';
    }
  }
}
```

`text`ã§å—ã‘å–ã£ã¦ã„ã‚‹ã‚‚ã®ã¯ã‚¿ã‚°ã®ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã§ã€elementã¯ã‚¿ã‚°è¦ç´ è‡ªä½“ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€å±æ€§ã‚’å–å¾—ã§ããŸã‚Šã—ã¾ã™ã€‚

ãã—ã¦ã€ãã‚Œãã‚Œã®Handlerã‚’ã‚¿ã‚°ã«çµã³ã¤ã‘ã€ãƒªãƒ³ã‚¯å…ˆã®Responseã‚’transformã—ã¾ã™ã€‚

```ts
const titleHandler = new TitleHandler();
const ogpHandler = new OgpHandler();
const faviconHandler = new FaviconHandler();
const res = new HTMLRewriter()
  .on('title', titleHandler)
  .on('meta', ogpHandler)
  .on('link', faviconHandler)
  .transform(siteRes);
await res.text();
```

ã“ã“ã§æœ€å¾Œã€`await res.text()`ã—ã¦ã„ã‚‹ã®ã¯ã€ã“ã®HTMLRewriterã¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ãªã®ã§æ¬²ã—ã„æƒ…å ±ã‚’å–å¾—ã§ããªã„ã¾ã¾ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ã—ã¾ã™ã‹ã‚‰ã§ã™ã€‚
ä»Šå›ã¯ã€ãƒ–ãƒ­ã‚°ã®è¨˜äº‹ã¯Static Generationã‚’ã—ã¦ãŠã‚Šãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã§ã‚ã¾ã‚Šé »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ã‚‚ã®ã§ã¯ãªã„ã¨ã„ã†æƒ³å®šã§ã€è¨±å®¹ã—ã¦ã„ã¾ã™ã€‚

ã‚ã¨ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã¤ã‘ã¦ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã ã‘ã§ã™ã€‚

```ts
const days = 24 * 60 * 60;
c.header('Cache-Control', `public, s-maxage=${1 * days}`);

return c.json({
  title: titleHandler.title ?? ogpHandler.title,
  description: ogpHandler.description,
  siteName: parsedUrl.hostname,
  faviconUrl: hasValidPrefix(faviconHandler.faviconUrl)
    ? faviconHandler.faviconUrl
    : `${parsedUrl.origin}${faviconHandler.faviconUrl}`,
});
```

faviconã®URLãŒhttpã‚„https,dataã‹ã‚‰å§‹ã¾ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã—ã€ãã†ã§ãªã„å ´åˆã¯originã‚’ã¤ã‘ã¦è¿”ã—ã¾ã™ã€‚

ã“ã‚Œã§ã€APIã®å®Ÿè£…ã¯å®Œæˆã§ã™ï¼

## Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

CLoudflareã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã€wranglerã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ¸ˆã¾ã›ã¾ã™ï¼ˆä»¥ä¸‹ã‚’å‚è€ƒï¼‰

https://reffect.co.jp/html/cloudflare-workers#Cloudflare_Workers

ãã®å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚Œã°ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã§ã™ï¼

```bash
npm run deploy
```

ã“ã‚Œã§ã€ã‚³ãƒãƒ³ãƒ‰ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹URLã‚’é€šã—ã¦APIã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

Cloudflareã®Workersã®è©³ç´°ç”»é¢ã‚’è¦‹ã‚‹ã¨ã€CPUæ™‚é–“ã®ä¸­å¤®å€¤ã¯5.1msãªã®ã§freeãƒ—ãƒ©ãƒ³ã®10msä»¥å†…ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã‚‹ã®ã§ã€ã²ã¨ã¾ãšã¯å¤§ä¸ˆå¤«ãã†ã§ã™

## çµ‚ã‚ã‚Šã«

ã‹ãªã‚Šç°¡å˜ã«ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã®å®Ÿè£…ãŒã§ãã¾ã—ãŸï¼  
ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã®1å€™è£œã¨ã—ã¦å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ğŸ«¡
