---
title: 'React Contextã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æœ¬å½“ã«ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ãªã®ã‹ã‚’è€ƒãˆã‚‹'
description: 'Reactã®Contextã«é–¢ã™ã‚‹å†…å®¹ã§ã€stateã¨setStateã‚’1ã¤ã®valueã«ã¾ã¨ã‚ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªããªã‚‹ã®ã§åˆ†ã‘ãŸã»ã†ãŒã„ã„ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ãŒã€æœãŸã—ã¦ãã‚Œã¯æœ¬å½“ã«æœ€å–„ãªã®ã ã‚ã†ã‹ï¼Ÿ'
published: true
pubDate: '2024/09/21 22:08'
tag: 'tech'
icon: 'animals-and-nature/72'
---

## ã¯ã˜ã‚ã«

ãªã‚“ã¨ãªãä½¿ã£ã¦ã„ãŸ React ã® Context ã«ã¤ã„ã¦ã€ã¡ã‚ƒã‚“ã¨ç†è§£ã§ãã¦ã„ãªã‹ã£ãŸã®ã§æ·±æ˜ã‚Šã—ã¦ã¿ã‚‹ã€‚

æ¤œç´¢ã—ã¦ã¿ã‚‹ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ã€state,setState ã‚’åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å…¥ã‚Œã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªããªã‚‹ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå¤šãç™ºç”Ÿã™ã‚‹ï¼‰ã¨ã„ã†ã‚‚ã®ãŒã‚ã£ãŸã€‚
ç¢ºã‹ã«ãã†ãªã®ã ãŒã€åˆ†ã‘ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãé‡ãŒå¢—ãˆã‚‹ãªã©ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚ã‚ã‚‹ã®ã§ã€ã©ã®ã‚ˆã†ã«ä½¿ã†ã®ãŒé©åˆ‡ãªã®ã‹ã‚’è€ƒãˆã¦ã¿ã‚‹ã€‚

## å•é¡Œã¨ãªã£ã¦ã„ã‚‹ã€ä¸€ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¾ã¨ã‚ã‚‹å ´åˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã€ã©ã“ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã€‚
ä»Šå›ã¯ç°¡æ˜“çš„ã« Vite ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```tsx title="App.tsx"
import { SetUserComponent1 } from './SetUserComponent1';
import { SetUserComponent2 } from './SetUserComponent2';
import { UserComponent } from './UserComponent';
import { UserProvider } from './UserProvider';

function App() {
  return (
    <UserProvider>
      <UserComponent />
      <SetUserComponent1 />
      <SetUserComponent2 />
    </UserProvider>
  );
}

export default App;
```

```tsx title="UserProvider.tsx"
import { createContext, useContext, useState } from 'react';

interface User {
  id: number;
  name: string;
}

interface UserContextValue {
  user: User | null;
  setUser: (user: User) => void;
}

const UserContext = createContext<UserContextValue | null>(null);

export function UserProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);

  return (
    <UserContext.Provider value={{ user, setUser }}>
      {children}
    </UserContext.Provider>
  );
}

export const useUserContext = () => {
  const ctx = useContext(UserContext);
  if (!ctx) throw new Error('useUser must be used within a UserProvider');

  return { user: ctx.user, setUser: ctx.setUser };
};
```

```tsx title="UserComponent.tsx"
import { useUserContext } from './UserProvider';

export function UserComponent() {
  const { user } = useUserContext();
  console.log('user', user);

  return (
    <section>
      <h2>User Component</h2>

      <p>user: {user?.name ?? 'null'}</p>
    </section>
  );
}
```

```tsx title="SetUserComponent1.tsx"
import { useUserContext } from './UserProvider';

export function SetUserComponent1() {
  const { setUser } = useUserContext();
  console.log('setUser 1');

  const handleClick = () => {
    setUser({ id: 1, name: 'John Doe' });
  };

  return (
    <section>
      <h2>SetUser Component 1</h2>

      <button onClick={handleClick}>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </button>
    </section>
  );
}
```

```tsx title="SetUserComponent2.tsx"
import { useUserContext } from './UserProvider';

export function SetUserComponent2() {
  const { setUser } = useUserContext();
  console.log('setUser 2');

  const handleClick = () => {
    setUser({ id: 2, name: 'Jane Smith' });
  };

  return (
    <section>
      <h2>SetUser Component 2</h2>Ã¥

      <button onClick={handleClick}>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </button>
    </section>
  );
}
```

`value={{ user, setUser }}`ãŒè‚ã§ã€`user` ã¨ `setUser` ã‚’1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã¦valueã‚’å…¥ã‚Œã¦ã„ã‚‹ã€‚

ã“ã®çŠ¶æ…‹ã§`SetUserComponent1`ã«ã‚ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€

![SetUserComponent1ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã®ãƒ­ã‚°](https://images.site.yajihum.dev/images/2024/09/0921_1.png)

`UserComponent`ã€`SetUserComponent1`ã€`SetUserComponent2` å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚  
`user`ãŒå¤‰æ›´ã•ã‚ŒãŸã®ã§`UserComponent`ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã¯ã‚ã‹ã‚‹ãŒã€`SetUserComponent1`ã€`SetUserComponent2` ã¯`setUser`ã ã‘ã‚’Contextã‹ã‚‰å—ã‘å–ã£ã¦ã„ã‚‹ã®ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹å¿…è¦ãŒãªã„ã€‚  

ã“ã®ç„¡é§„ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ç†ç”±ã¯ä»¥ä¸‹ã§ã‚ã‚‹ã€‚[^1]
- Reactã§ã¯ã€ç•°ãªã‚‹valueã‚’å—ã‘å–ã‚‹ã¨ã€Provideré…ä¸‹ã®å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
- ç•°ãªã‚‹valueã‹ã©ã†ã‹ã‚’åˆ¤åˆ¥ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦`Object.is`ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹
- `user`ã®ä¸­èº«ãŒ`setUser`ã«ã‚ˆã‚Šå¤‰ã‚ã£ãŸãŸã‚ã€`{ user, setUser }` ã¯ç•°ãªã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãªã‚Šã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹

## ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã®è§£æ±ºç­–

ã“ã‚ŒãŒæœ¬å½“ã«ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã¯ç½®ã„ã¨ã„ã¦ã€ç„¡é§„ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã‚‹ã€‚

1ã¤ã®è§£æ±ºç­–ã¨ã—ã¦ã€`user` ã¨ `setUser` ã‚’åˆ†ã‘ã‚‹æ–¹æ³•ãŒã‚ã‚‹ã€‚

```tsx title="UserProvider.tsx"
// <User | null>ã®å‹ã ã¨contextãŒå–å¾—ã§ããªã‹ã£ãŸ
const UserContext = createContext<{ user: User | null } | null>(null);
const SetUserContext = createContext<((user: User) => void) | null>(null);

export function UserProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);

  // MemoåŒ–ã™ã‚‹ã“ã¨ã§userãŒåŒã˜ã§ã‚ã‚‹å ´åˆã«æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã‚’é˜²ã
  const userValue = useMemo(() => ({ user }), [user]);

  return (
    <UserContext.Provider value={{ user }}>
      <SetUserContext.Provider value={setUser}>
        {children}
      </SetUserContext.Provider>
    </UserContext.Provider>
  );
}

export const useUserContext = () => {
  const ctx = useContext(UserContext);
  if (!ctx) throw new Error('useUser must be used within a UserProvider');

  return ctx;
};

export const useSetUserContext = () => {
  const ctx = useContext(SetUserContext);
  if (!ctx) throw new Error('useSetUser must be used within a UserProvider');

  return { setUser: ctx };
};
```

ã“ã®æ–¹æ³•ã§å†åº¦è©¦ã—ã¦ã¿ã‚‹ã€‚

![SetUserComponent1ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã®ãƒ­ã‚°](https://images.site.yajihum.dev/images/2024/09/0921_2.png)

`SetUserComponent1` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€`UserComponent` ã ã‘ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚
`user`ãŒå¤‰æ›´ã•ã‚Œã¦ã‚‚`SetUserContext`ã®valueã€ã¤ã¾ã‚Š`setUser`ã¯å¤‰åŒ–ã—ãªã„ã®ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã—ãªã„ã€‚

## 1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹ã®ã¯æœ¬å½“ã«ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ï¼Ÿ

æœ¬é¡Œã«æˆ»ã£ã¦ã€å…ˆã»ã©ç´¹ä»‹ã—ãŸ1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹å ´åˆã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’è€ƒãˆã¦ã¿ã‚‹ã€‚

1. 1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹å ´åˆ
    - ãƒ¡ãƒªãƒƒãƒˆ
        - Contextã‚„Providerã®æ•°è‡ªä½“ã‚„contextã®å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ãŒå¢—ãˆãšã€ä¿å®ˆæ€§ãƒ»å¯èª­æ€§ãŒä¸ŠãŒã‚‹
        - state,setStateã®é–¢ä¿‚ãŒã‚ã‹ã‚Šã‚„ã™ã„
    - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
        - ç„¡é§„ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚‹

åˆ†ã‘ã‚‹å ´åˆã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¯ã“ã®é€†ã§ã‚ã‚‹ã€‚
åˆ†ã‘ã‚‹å ´åˆã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨å¼•ãæ›ãˆã«ã€ä¿å®ˆæ€§ãƒ»å¯èª­æ€§ã‚’ä¸‹ã’ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã¯å¿˜ã‚Œãªã„ã§ãŠããŸã„ã€‚


## ä»–ã®æ ¹æ‹ ã¨ãªã‚‹æƒ…å ±

### Reactã®useContextã®èª¬æ˜ã§æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹ä¾‹

Contextã®ä½¿ç”¨ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹ã§`value={{ currentUser, setCurrentUser }}`ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚

https://ja.react.dev/reference/react/useContext#updating-an-object-via-context

ã‚‚ã—ã€1ã¤ã«ã¾ã¨ã‚ã‚‹ã®ãŒæœ¬å½“ã«å•é¡Œã§ã‚ã‚Œã°ã“ã®æ–¹æ³•ã‚’è¼‰ã›ãªã„ã‹ã€æ³¨æ„æ›¸ãã‚„éæ¨å¥¨ãªã©ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã†ã€‚

### Kent C. Dodds ã•ã‚“ã®è¨˜äº‹

ãã‚‚ãã‚‚ãªãœä¸å¿…è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒè‰¯ããªã„ã¨æ€ã‚ã‚Œã¦ã„ã‚‹ã ã‚ã†ã‹ï¼Ÿ
Kentã•ã‚“ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã—ã¦ã„ã‚‹ã€‚[^5]

> ã€ŒDOMã¯é…ã„ã€ã¨ã„ã†è©±ã‚’èã„ãŸã“ã¨ãŒã‚ã‚‹äººã¯å¤šã„ã§ã™ãŒã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã‚‚å¿…ãšã—ã‚‚DOMãŒæ›´æ–°ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã“ã¨ã‚’ç†è§£ã—ã¦ã„ãªã„äººã‚‚å¤šã„ã§ã™ã€‚
> ã“ã®èª¤è§£ã®ãŸã‚ã«ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå®Ÿéš›ã«ã¯DOMã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒãªã„ã¨ãã§ã‚‚ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‹ã¨ä¿¡ã˜ã¦ã—ã¾ã†ã®ã§ã™ã€‚
>
> ç¢ºã‹ã«ã€ã“ã‚Œã¯å ´åˆã«ã‚ˆã£ã¦ã¯å•é¡Œã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ã«ã¯ä½ã‚¹ãƒšãƒƒã‚¯ã®ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã‚‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆï¼ˆãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã‚„æ¯”è¼ƒï¼ˆãƒªã‚³ãƒ³ã‚µã‚¤ãƒ«ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã¯éå¸¸ã«é«˜é€Ÿã§ã™ã€‚

ã¾ãŸã€Contextã‚’æœ€é©åŒ–ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã‚‹è¨˜äº‹ã§ã¯ã€

> ã‚‚ã—ã‚³ãƒ¼ãƒ‰ãŒé…ããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã¨æ€ã£ã¦ã“ã†ã„ã£ãŸã“ã¨ã‚’ã™ã‚‹ã¤ã‚‚ã‚Šãªã‚‰ã€ã‚„ã‚ã¦ãŠã„ãŸæ–¹ãŒã„ã„ã§ã™ã€‚å†—è«‡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
> Reactã¯æœ¬å½“ã«é«˜é€Ÿã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒååˆ†ã«è‰¯ã„ã¨ãã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åã®ä¸‹ã«è¤‡é›‘ã•ã‚’è¿½åŠ ã™ã‚‹ã®ã¯ã€ã€Œè¤‡é›‘ã•ã®äºˆç®—ã€ã‚’ç„¡é§„ã«ã™ã‚‹ã ã‘ã§ã™ã€‚

ãªã®ã§ã€ç‰¹ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ãªã„ãªã‚‰ã€ç„¡é§„ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ãã“ã¾ã§æ°—ã«ã™ã‚‹å¿…è¦ã¯ãªã„ã—ã€ä»–ã®åŸå› ï¼ˆä¾‹ãˆã°APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…ã„ãªã©ï¼‰ã‚’è¦‹ç›´ã™ã¹ãã ã¨æ€ã†ã€‚

## ã¾ã¨ã‚

å€‹äººçš„ã«ã¯ã€ç„¡é§„ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹å ´åˆã§ã‚‚ã€ä¿å®ˆæ€§ãƒ»å¯èª­æ€§ãŒä¸ŠãŒã‚‹ã®ã§ã‚ã‚Œã°1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹ã»ã†ãŒãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹ã¨æ„Ÿã˜ãŸã€‚

ã¾ãŸã€åŠ¹æœçš„ãªContextã®ä½¿ã„æ–¹ã€æ›¸ãæ–¹ã¨ã—ã¦ä»¥ä¸‹ã§useReducerã‚’ä½µç”¨ã™ã‚‹ä¾‹ãŒã‚ã‚‹ã®ã§å‚è€ƒã«ãªã‚‹ã‹ã‚‚çŸ¥ã‚Œãªã„ï¼  

https://kentcdodds.com/blog/how-to-use-react-context-effectively  


## ï¼ˆãŠã¾ã‘ï¼‰useStateã®ä»•çµ„ã¿

ãã‚‚ãã‚‚ã€ãªãœseté–¢æ•°å´ã¯å€¤ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã¨åˆ¤æ–­ã•ã‚Œã‚‹ã®ã ã‚ã†ã‹ï¼Ÿï¼ˆstateå´ãŒå€¤ãŒå¤‰ã‚ã‚‹ã®ã¯è‡ªæ˜ã ã‘ã©ã‚‚ï¼‰

ã“ã®ç†ç”±ã«ã¤ã„ã¦ã‚ã‹ã£ã¦ã„ã‚‹äººã‚‚å¤šã„ã¨æ€ã†ãŒã€è‡ªåˆ†ã¯æ¥ãšã‹ã—ãªãŒã‚‰seté–¢æ•°ã¯stateãŒå¤‰ã‚ã‚‹ãŸã³ã«å€¤ãŒå¤‰åŒ–ã™ã‚‹(å†ç”Ÿæˆã•ã‚Œã‚‹)ã®ã§ã¯ãªã„ã‹ã¨æ¼ ç„¶ã¨æ€ã£ã¦ã„ãŸã€‚
ã¾ãŸã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸­ã§ä½œæˆã—ãŸé–¢æ•°ã¯ä½•ã‚‚ã—ãªã„ã¨æ¯å›æ–°ã—ãç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€seté–¢æ•°ã§ã‚‚åŒã˜ã‚ˆã†ãªæŒ™å‹•ã‚’ã™ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã£ã¦ã„ãŸã€‚ (ã‚ˆãè€ƒãˆãŸã‚‰å†ç”Ÿæˆã•ã‚Œã‚‹ã®ã¯ã€UserProviderè‡ªä½“ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„ã¨ç™ºç”Ÿã—ãªã„ã®ã§2ã¤ç›®ã®ç†ç”±ã¯è¦‹å½“é•ã„)

ãµã«ã‚ƒãµã«ã‚ƒç†è§£ã™ãã‚‹ã®ã§ã€useStateã«ã¤ã„ã¦ã¡ã‚ƒã‚“ã¨èª¿ã¹ã¦ã¿ã‚ˆã†ï¼

useStateã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
- useStateã¯Reactå´ãŒç”¨æ„ã—ãŸé–¢æ•°ã§ã‚ã‚Šã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã‚ã‚‹ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸­ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦å†ç”Ÿæˆã•ã‚Œã‚‹ã‚‚ã®ã§ã¯ãªã„ï¼‰
- å‹ã¯`function useState<S>(initialState: S | (() => S)): [S, Dispatch<SetStateAction<S>>]`ã§ã‚ã‚Šã€`[state, setState]`ã®ã‚¿ãƒ—ãƒ«ã‚’è¿”ã™[^2]
- `setState`ã¯å†…éƒ¨ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ç´”ç²‹é–¢æ•°[^3]ã§ã‚ã‚Šã€Reactå´ã§ç®¡ç†ã—ã¦ã„ã‚‹stateã®å€¤ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã ã‘ã®æ±ºã¾ã£ãŸé–¢æ•°ã§ã‚ã‚‹


### ğŸ” å†…éƒ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹

â€»èˆˆå‘³ãªã„äººã¯é£›ã°ã—ã¦ã‚‚ã„ã„

Reactã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹[^4]

```tsx title="react/packages/react-reconciler/src/ReactFiberHooks.js"
const HooksDispatcherOnMount: Dispatcher = {
  ~~~
  useState: mountState,
  ~~~
};
```
åå‰ã‹ã‚‰ã‚ã‹ã‚‹ã‚ˆã†ã«useStateã¨ã„ã†ãƒ•ãƒƒã‚¯ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹æ™‚ã«ã¯`mountState`ã¨ã„ã†é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹ã‚ˆã†ã§ã‚ã‚‹ã€‚

ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½¿ç”¨ã•ã‚Œã‚‹éƒ¨åˆ†ã‚’è¦‹ã‚‹ã¨ã€

`export function renderWithHooks<Props, SecondArg>`ã¨ã„ã†é–¢æ•°ã®ä¸­ã§`HooksDispatcherOnMount`ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚

```tsx title="react/packages/react-reconciler/src/ReactFiberHooks.js"
~~~
ReactSharedInternals.H =
      current === null || current.memoizedState === null
        ? HooksDispatcherOnMount
        : HooksDispatcherOnUpdate;
~~~
```
`ReactSharedInternals.H`ã«`HooksDispatcherOnMount`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

```tsx title="react/packages/react-reconciler/src/ReactFiberHooks.js"
function mountState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  const hook = mountStateImpl(initialState);
  const queue = hook.queue;

  // ã“ã‚Œ
  const dispatch: Dispatch<BasicStateAction<S>> = (dispatchSetState.bind(
    null,
    currentlyRenderingFiber,
    queue,
  ): any);

  queue.dispatch = dispatch;
  return [hook.memoizedState, dispatch];
}

function mountStateImpl<S>(initialState: (() => S) | S): Hook {
  const hook = mountWorkInProgressHook();
  if (typeof initialState === 'function') {
    const initialStateInitializer = initialState;
    // $FlowFixMe[incompatible-use]: Flow doesn't like mixed types
    initialState = initialStateInitializer();
    if (shouldDoubleInvokeUserFnsInHooksDEV) {
      setIsStrictModeForDevtools(true);
      // $FlowFixMe[incompatible-use]: Flow doesn't like mixed types
      initialStateInitializer();
      setIsStrictModeForDevtools(false);
    }
  }
  hook.memoizedState = hook.baseState = initialState;
  const queue: UpdateQueue<S, BasicStateAction<S>> = {
    pending: null,
    lanes: NoLanes,
    dispatch: null,
    lastRenderedReducer: basicStateReducer,
    lastRenderedState: (initialState: any),
  };
  hook.queue = queue;
  return hook;
}
```
`mountState`é–¢æ•°ã§ã¯`dispatch`é–¢æ•°ã‚’ç”Ÿæˆã—ã¦ã€`[state, setState]`ã®ã‚¿ãƒ—ãƒ«ã‚’è¿”ã—ã¦ã„ãã†ã€‚
ã¾ãŸã€`mountStateImpl`ã§`queue`ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãŠã‚Šã€`dispatch`ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

```tsx title="react/packages/react-reconciler/src/ReactFiberHooks.js"
function dispatchSetState<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A,
): void {
  if (__DEV__) {
    if (typeof arguments[3] === 'function') {
      console.error(
        "State updates from the useState() and useReducer() Hooks don't support the " +
          'second callback argument. To execute a side effect after ' +
          'rendering, declare it in the component body with useEffect().',
      );
    }
  }

  const lane = requestUpdateLane(fiber);
  const didScheduleUpdate = dispatchSetStateInternal(
    fiber,
    queue,
    action,
    lane,
  );
  if (didScheduleUpdate) {
    startUpdateTimerByLane(lane);
  }
  markUpdateInDevTools(fiber, lane, action);
}

function dispatchSetStateInternal<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A,
  lane: Lane,
): boolean {
  const update: Update<S, A> = {
    lane,
    revertLane: NoLane,
    action,
    hasEagerState: false,
    eagerState: null,
    next: (null: any),
  };

  if (isRenderPhaseUpdate(fiber)) {
    enqueueRenderPhaseUpdate(queue, update);
  } else {
    const alternate = fiber.alternate;
    if (
      fiber.lanes === NoLanes &&
      (alternate === null || alternate.lanes === NoLanes)
    ) {
      // The queue is currently empty, which means we can eagerly compute the
      // next state before entering the render phase. If the new state is the
      // same as the current state, we may be able to bail out entirely.
      const lastRenderedReducer = queue.lastRenderedReducer;
      if (lastRenderedReducer !== null) {
        let prevDispatcher = null;
        if (__DEV__) {
          prevDispatcher = ReactSharedInternals.H;
          ReactSharedInternals.H = InvalidNestedHooksDispatcherOnUpdateInDEV;
        }
        try {
          const currentState: S = (queue.lastRenderedState: any);
          const eagerState = lastRenderedReducer(currentState, action);
          // Stash the eagerly computed state, and the reducer used to compute
          // it, on the update object. If the reducer hasn't changed by the
          // time we enter the render phase, then the eager state can be used
          // without calling the reducer again.
          update.hasEagerState = true;
          update.eagerState = eagerState;
          if (is(eagerState, currentState)) {
            // Fast path. We can bail out without scheduling React to re-render.
            // It's still possible that we'll need to rebase this update later,
            // if the component re-renders for a different reason and by that
            // time the reducer has changed.
            // TODO: Do we still need to entangle transitions in this case?
            enqueueConcurrentHookUpdateAndEagerlyBailout(fiber, queue, update);
            return false;
          }
        } catch (error) {
          // Suppress the error. It will throw again in the render phase.
        } finally {
          if (__DEV__) {
            ReactSharedInternals.H = prevDispatcher;
          }
        }
      }
    }

    const root = enqueueConcurrentHookUpdate(fiber, queue, update, lane);
    if (root !== null) {
      scheduleUpdateOnFiber(root, fiber, lane);
      entangleTransitionUpdate(root, queue, lane);
      return true;
    }
  }
  return false;
}
```
`dispatchSetStateInternal`ãŒseté–¢æ•°ã®æœ¬ä½“ã®ã‚ˆã†ã§ã‚ã‚‹ã€‚
ã“ã“ã§ã¯`const eagerState = lastRenderedReducer(currentState, action);`ã®éƒ¨åˆ†ã§`eagerï¼ˆå…ˆè¡Œã€å³åº§ãªã©ã®æ„ï¼‰`ãªstateã‚’è¨ˆç®—ã—ã¦ã„ã‚‹ã€‚

```tsx
const queue: UpdateQueue<S, BasicStateAction<S>> = {
    pending: null,
    lanes: NoLanes,
    dispatch: null,
    lastRenderedReducer: basicStateReducer,
    lastRenderedState: (initialState: any),
  };
```   
`lastRenderedReducer`ã‚’æ¢ã™ã¨ã€`queue`ã®åˆæœŸåŒ–æ™‚ã«`basicStateReducer`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚

```tsx
function basicStateReducer<S>(state: S, action: BasicStateAction<S>): S {
  // $FlowFixMe[incompatible-use]: Flow doesn't like mixed types
  return typeof action === 'function' ? action(state) : action;
}
```
actionã«é–¢æ•°ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã¯ãã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã€ãã‚Œä»¥å¤–ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
ã“ã“ã§å—ã‘å–ã£ã¦ã„ã‚‹actionã¯ä¾‹ãˆã°`setUser({ id: 1, name: 'John Doe' });`ã®`{ id: 1, name: 'John Doe' }`ã®ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã‚‹ã€‚

æµã‚Œã¨ã—ã¦ã¯ã€seté–¢æ•°ã‚’å®Ÿè¡Œã—ãŸã¨ãã«æ¸¡ã™å€¤ãŒ`eagerState`ã¨ãªã‚Šã€`is(eagerState, currentState)`ã®éƒ¨åˆ†ã§`currentState`ã¨é•ã†å€¤ã‹ã©ã†ã‹ã‚’åˆ¤åˆ¥ã—ã€é•ã†ã¨åˆ¤æ–­ã•ã‚ŒãŸå ´åˆã«ã‚­ãƒ¥ãƒ¼ã¨ã—ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹stateã‚’æ›´æ–°ã—ã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç™ºç”Ÿã•ã›ã‚‹ã€‚

```tsx
const dispatch: Dispatch<BasicStateAction<S>> = (dispatchSetState.bind(
    null,
    currentlyRenderingFiber,
    queue,
  ): any);
```

ã“ã®ã‚¿ãƒ—ãƒ«ã¨ã—ã¦ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹dispatchã«æˆ»ã‚‹ã¨`dispatchSetState.bind`ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€`dispatchSetState`ã§ã¯ç¬¬3å¼•æ•°ã«`action`ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã€‚
ã“ã®actionã¯seté–¢æ•°ã‚’å‘¼ã³å‡ºã™æ™‚ã«æ¸¡ã•ã‚Œã‚‹å¼•æ•°ã®ã“ã¨ã§ã‚ã‚Šã€å…ˆã»ã©ã®`basicStateReducer`ã«æ¸¡ã•ã‚Œã¦ã„ã‚‹ã€‚

### seté–¢æ•°ã®å†ç”Ÿæˆã«ã¤ã„ã¦çµè«–

ä»¥ä¸Šã‹ã‚‰ã€æœ€åˆã®å•ã„ã«å¯¾ã™ã‚‹ç­”ãˆã¨ã—ã¦ã¯ã€seté–¢æ•°ã¯`dispatch`ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤–ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹æ±ºã¾ã£ãŸé–¢æ•°ã§ã‚ã‚‹ãŸã‚ã€ä½•ã‚‰ã‹ã®å½±éŸ¿ã«ã‚ˆã‚Šå†ç”Ÿæˆã•ã‚Œã‚‹ã‚‚ã®ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã£ãŸã€‚
ç¢ºã‹ã«ã€ã‚ˆãè€ƒãˆã‚Œã°å€¤ã‚’æ›´æ–°ã™ã‚‹ã ã‘ã®å›ºå®šã®é–¢æ•°ã«ãªã‚‹ã¯ãšã§ã‚ã‚‹ã€‚

##  å‚ç…§æƒ…å ±

https://github.com/facebook/react  

https://zenn.dev/yuta_ura/articles/react-context-api  

https://ja.react.dev/reference/react/useContext


[^1]: https://ja.react.dev/reference/react/useContext#caveats
[^2]: å³å¯†ã«ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã®`function useState<S = undefined>(): [S | undefined, Dispatch<SetStateAction<S | undefined>>]`ã‚‚ã‚ã‚‹
[^3]: https://ja.react.dev/learn/keeping-components-pure#purity-components-as-formulas
[^4]: https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L1920-L1932
[^5]: https://kentcdodds.com/blog/fix-the-slow-render-before-you-fix-the-re-render#unnecessary-re-renders